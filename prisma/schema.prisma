generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums para roles y tipos de transacci贸n
enum Role {
  STUDENT
  TEACHER
  ADMIN
}

enum TransactionType {
  EARNED   // Puntos ganados
  REDEEMED // Puntos gastados
}

enum RedemptionStatus {
  PENDING
  APPROVED
  REJECTED
}

// Modelo de Usuario (Docentes y Estudiantes)
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  fullName  String
  role      Role     @default(STUDENT)

  // Perfil extra para Docentes (Cartas)
  bio       String?
  avatarUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones Inversas
  subjectsTeaching Subject[]         @relation("TeacherSubjects")
  enrollments      Enrollment[]
  pointBalances    PointBalance[]
  transactions     PointTransaction[]
  redemptions      RedemptionRequest[]
  
  //  ESTA LNEA ES VITAL PARA QUE FUNCIONE LA MIGRACIN 
  achievements     Achievement[]
}

// Materias/Clases
model Subject {
  id        String   @id @default(uuid())
  name      String
  cycle     String   // Ej: "Ciclo 1"
  year      Int
  joinCode  String   @unique // C贸digo 煤nico (Ej: "X7Y2")

  teacherId String
  teacher   User     @relation("TeacherSubjects", fields: [teacherId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones Inversas
  enrollments   Enrollment[]
  pointBalances PointBalance[]
  transactions  PointTransaction[]
  rewards       Reward[]
  questions     Question[] 
}

// Inscripciones (Estudiante <-> Materia)
model Enrollment {
  id        String   @id @default(uuid())
  studentId String
  subjectId String
  joinedAt  DateTime @default(now())

  student User    @relation(fields: [studentId], references: [id])
  subject Subject @relation(fields: [subjectId], references: [id])

  @@unique([studentId, subjectId]) // Evita duplicados
}

// Saldo de Puntos (El coraz贸n del sistema)
model PointBalance {
  id        String @id @default(uuid())
  amount    Int    @default(0)

  studentId String
  subjectId String
  student   User    @relation(fields: [studentId], references: [id])
  subject   Subject @relation(fields: [subjectId], references: [id])

  @@unique([studentId, subjectId])
}

// Historial de Transacciones (Auditor铆a)
model PointTransaction {
  id        String          @id @default(uuid())
  amount    Int             // Positivo = gan贸, Negativo = gast贸
  type      TransactionType
  reason    String?         // Ej: "Ganador Stroop"

  studentId String
  subjectId String
  student   User    @relation(fields: [studentId], references: [id])
  subject   Subject @relation(fields: [subjectId], references: [id])

  createdAt DateTime @default(now())
}

// Recompensas Canjeables
// ... (resto del schema igual)

model Reward {
  id          String @id @default(uuid())
  name        String // T铆tulo
  description String? // NUEVO: Para la descripci贸n larga
  cost        Int
  isActive    Boolean @default(true) // NUEVO: Para activar/desactivar

  subjectId   String
  subject     Subject @relation(fields: [subjectId], references: [id])

  redemptions RedemptionRequest[]
}

// Solicitudes de Canje
model RedemptionRequest {
  id     String           @id @default(uuid())
  status RedemptionStatus @default(PENDING)

  studentId String
  rewardId  String
  student   User   @relation(fields: [studentId], references: [id])
  reward    Reward @relation(fields: [rewardId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Modelo para las Preguntas de Batalla
model Question {
  id        String   @id @default(uuid())
  text      String   // El texto de la pregunta
  subjectId String   // A qu茅 materia pertenece esta pregunta
  subject   Subject  @relation(fields: [subjectId], references: [id])

  options   Option[] // Relaci贸n a las 4 opciones

  @@index([subjectId]) // Optimizaci贸n para buscar preguntas por materia
}

// Modelo para las Opciones de una Pregunta
model Option {
  id        String   @id @default(uuid())
  text      String   // El texto de la opci贸n (ej: "42")
  isCorrect Boolean  // true si es la respuesta correcta, false si no

  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade) 

  @@index([questionId])
} 

model Achievement {
  id          String   @id @default(uuid())
  title       String
  description String
  icon        String
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  createdAt   DateTime @default(now())
}