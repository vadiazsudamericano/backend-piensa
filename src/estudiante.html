<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESTUDIANTE: Bot√≥n de Batalla</title>
    <!-- Script para Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        /* Estilos generales y responsive */
        body { 
            font-family: 'Inter', sans-serif; 
            padding: 20px; 
            background-color: #f0f4f8; 
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .container { 
            max-width: 600px; 
            width: 95%;
            margin-top: 20px;
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        h1 { 
            color: #0056b3; 
            font-size: 2em;
            margin-bottom: 5px;
        }
        .meta-info {
            background-color: #e6f7ff;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        .meta-info p { margin: 5px 0; }
        
        /* Indicador de Conexi√≥n Socket */
        #socketStatus {
            font-size: 0.8em;
            font-weight: bold;
            padding: 5px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: inline-block;
        }
        .socket-connected { background-color: #d4edda; color: #155724; }
        .socket-disconnected { background-color: #f8d7da; color: #721c24; }
        .socket-pending { background-color: #fff3cd; color: #856404; }


        /* Estilos de la Pregunta */
        #questionDisplay {
            min-height: 100px;
            padding: 20px;
            margin-bottom: 25px;
            background-color: #007bff;
            color: white;
            border-radius: 10px;
            font-size: 1.4em;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Estilos del Bot√≥n Principal */
        #pressButton { 
            padding: 40px 20px; 
            width: 90%; 
            height: 200px; 
            font-size: 2.5em; 
            background-color: #28a745; /* Verde (Habilitado) */
            color: white; 
            border: none; 
            border-radius: 15px; 
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 5px 0 #1e7e34;
        }
        #pressButton:active:not(:disabled) {
            transform: translateY(4px);
            box-shadow: 0 1px 0 #1e7e34;
        }
        #pressButton:hover:not(:disabled) { background-color: #218838; }
        #pressButton:disabled { 
            background-color: #9f9f9f; /* Gris (Deshabilitado) */
            cursor: not-allowed; 
            box-shadow: none;
        }
        
        /* Estilos del Mensaje de Estado */
        #statusMessage { 
            margin-top: 20px; 
            padding: 10px;
            font-size: 1.2em; 
            font-weight: bold; 
            border-radius: 8px;
        }
        .info { background-color: #fff3cd; color: #856404; } /* Amarillo */
        .win { background-color: #d4edda; color: #155724; } /* Verde claro */
        .lose { background-color: #f8d7da; color: #721c24; } /* Rojo claro */

        /* Estilos del Log de Notificaciones */
        .log-container { 
            text-align: left; 
            margin-top: 30px; 
            border-top: 1px solid #eee; 
            padding-top: 15px; 
            max-height: 200px;
            overflow-y: auto;
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
        }
        .log-container h3 { color: #333; margin-top: 0; }
        #log div { 
            padding: 5px 0; 
            border-bottom: 1px dotted #ccc;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßë‚Äçüéì Cliente Estudiante</h1>
        <!-- Indicador de estado de la conexi√≥n Socket -->
        <span id="socketStatus" class="socket-pending">ESTADO: Pendiente</span>

        <!-- Informaci√≥n de Conexi√≥n -->
        <div class="meta-info">
            <p><strong>Jugador:</strong> <span id="playerNameDisplay">Cargando...</span></p>
            <p><strong>Sala (Room ID):</strong> <span id="roomIdDisplay">Cargando...</span></p>
            <p class="text-xs">Nota: Abre otra ventana para el Maestro y m√°s Jugadores, usando el mismo Room ID.</p>
        </div>

        <!-- Visualizaci√≥n de la Pregunta -->
        <div id="questionDisplay">Esperando la primera pregunta del Maestro...</div>
        
        <!-- Bot√≥n de Pulsaci√≥n (Buzzer) -->
        <button id="pressButton" disabled>PRESIONAR</button>
        
        <!-- Mensaje de Estado -->
        <div id="statusMessage" class="info">Conectando...</div>

        <!-- Log de Notificaciones -->
        <div class="log-container">
            <h3>Notificaciones del Servidor:</h3>
            <div id="log"></div>
        </div>
    </div>

    <script>
        const socketUrl = 'http://localhost:3000'; 
        let socket;
        const pressButton = document.getElementById('pressButton');
        const statusMessage = document.getElementById('statusMessage');
        const questionDisplay = document.getElementById('questionDisplay');
        const logElement = document.getElementById('log');
        const socketStatus = document.getElementById('socketStatus');


        // --- DATOS DE PRUEBA CENTRALES (AJUSTA ESTOS VALORES) ---
        const TEST_ROOM_ID = 'Sala-001'; // ¬°Debe coincidir con la sala del Maestro!
        const TEST_STUDENT_ID = `student-${Math.random().toString(36).substring(2, 6)}`; // ID √öNICO
        const TEST_PLAYER_NAME = `Jugador ${TEST_STUDENT_ID.slice(-4)}`;
        const TEST_SUBJECT_ID = 'subject-xyz-456';
        
        // Mostrar datos en la UI
        document.getElementById('playerNameDisplay').textContent = TEST_PLAYER_NAME;
        document.getElementById('roomIdDisplay').textContent = TEST_ROOM_ID;
        // --------------------------------------------------------

        // Funci√≥n para a√±adir mensajes al log
        function log(message, className = '') {
            const entry = document.createElement('div');
            entry.className = className;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logElement.prepend(entry);
            console.log(`[ESTUDIANTE LOG - ${TEST_PLAYER_NAME}] ${message}`); // Log adicional en consola
        }
        
        // Funci√≥n para actualizar el mensaje de estado principal
        function updateStatus(message, className = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = className;
        }

        function updateSocketStatus(isConnected) {
            if (isConnected) {
                socketStatus.textContent = "ESTADO: CONECTADO";
                socketStatus.className = "socket-connected";
            } else {
                socketStatus.textContent = "ESTADO: DESCONECTADO/ERROR";
                socketStatus.className = "socket-disconnected";
            }
        }

        // Funci√≥n para unirse a la sala
        function joinGame() {
            log(`Intentando unirse a la sala: ${TEST_ROOM_ID}`);
            socket.emit('joinGame', {
                roomId: TEST_ROOM_ID,
                studentId: TEST_STUDENT_ID,
                playerName: TEST_PLAYER_NAME,
                isMaster: false // Indica que es un cliente estudiante
            });
        }

        // Funci√≥n principal para conectar el socket y escuchar eventos
        function connectSocket() {
            updateStatus('Intentando conectar...', 'info');
            updateSocketStatus(false);
            
            // Conexi√≥n al servidor WebSocket
            socket = io.connect(socketUrl, { 
                reconnection: true, 
                reconnectionAttempts: 5 
            }); 

            // Evento: Error de conexi√≥n 
            socket.on('connect_error', (err) => {
                updateStatus(`‚ùå Error de conexi√≥n: ${err.message}. Verifica que NestJS est√© corriendo.`, 'lose'); 
                log(`ERROR AL CONECTAR: ${err.message}`);
                updateSocketStatus(false);
                pressButton.disabled = true; 
            });

            // Evento: Conexi√≥n exitosa
            socket.on('connect', () => { 
                updateStatus('‚úÖ Conectado al WebSocket. Uni√©ndose a la sala...', 'info'); 
                updateSocketStatus(true);
                joinGame();
            });
            
            // Evento: Desconexi√≥n
            socket.on('disconnect', () => { 
                updateStatus('‚ùå Desconectado. Recarga la p√°gina.', 'lose'); 
                updateSocketStatus(false);
                pressButton.disabled = true; 
            });
            
            // Evento: El Maestro envi√≥ una nueva pregunta
            socket.on('newQuestion', (data) => {
                // --- DEPURACI√ìN AGRESIVA ---
                console.error(`!!! üöÄ EVENTO 'newQuestion' RECIBIDO en ${TEST_PLAYER_NAME} !!!`); 
                console.log(`DATOS RECIBIDOS:`, data);
                // ---------------------------
                
                questionDisplay.textContent = data.question;
                
                // --- L√ìGICA DE HABILITACI√ìN CLAVE ---
                pressButton.disabled = false;
                // ------------------------------------
                
                updateStatus('üü¢ ¬°PREGUNTA RECIBIDA! Presiona para responder.', 'win');
                log(`üéâ [newQuestion RECIBIDO] ¬°Bot√≥n HABILITADO! Pregunta: ${data.question}`); 
                
                // --- CHEQUEO POST-HABILITACI√ìN ---
                if (!pressButton.disabled) {
                    console.error(`!!! ‚úÖ Bot√≥n habilitado exitosamente! disabled = ${pressButton.disabled} !!!`);
                } else {
                    console.error(`!!! ‚ùå ERROR: Bot√≥n sigue deshabilitado despu√©s de newQuestion! disabled = ${pressButton.disabled} !!!`);
                }
            });

            // Evento: Un jugador presion√≥ (inclu√≠do yo)
            socket.on('playerPressed', (data) => {
                log(`Pulsaci√≥n registrada: ${data.playerName} (Orden: ${data.order})`);
                if (data.isFirst) { 
                    log(`üéâ ¬°${data.playerName} presion√≥ primero! Ronda bloqueada.`, 'lose'); 
                    pressButton.disabled = true; // Bloquea si alguien (incluido yo) puls√≥ primero
                    updateStatus(`üî¥ Ronda Bloqueada. Ganador potencial: ${data.playerName}.`, 'lose');
                }
            });

            // Evento: El Maestro declar√≥ un ganador
            socket.on('gameWinner', (data) => {
                if (data.winnerName.trim() === TEST_PLAYER_NAME.trim()) {
                    updateStatus('üèÜ ¬°ERES EL GANADOR DE LA RONDA!', 'win');
                } else {
                    updateStatus(`‚ùå Perdiste. Gan√≥: ${data.winnerName}`, 'lose');
                }
                pressButton.disabled = true;
            });

            // Evento: Mensajes generales de estado del servidor/Maestro
            socket.on('statusUpdate', (data) => {
                log(`Servidor: ${data.message}`);
                
                if (data.message.includes('reiniciado') || data.type === 'reset') {
                    pressButton.disabled = true; 
                    questionDisplay.textContent = 'Esperando nueva pregunta...';
                    updateStatus('üü° Ronda Reiniciada. Esperando pregunta del Maestro.', 'info');
                }
            });
        }
        
        // Manejador de evento al presionar el bot√≥n
        pressButton.addEventListener('click', () => {
            // Se puede presionar el bot√≥n si NO est√° deshabilitado
            if (!pressButton.disabled) {
                pressButton.disabled = true; // Deshabilitar inmediatamente para evitar pulsaciones m√∫ltiples
                updateStatus('Presionado. Esperando respuesta del servidor...', 'info');
                
                if (socket && socket.connected) {
                    // Emitir la pulsaci√≥n al servidor
                    socket.emit('buttonPress', { 
                        studentId: TEST_STUDENT_ID, 
                        subjectId: TEST_SUBJECT_ID,
                        playerName: TEST_PLAYER_NAME,
                        roomId: TEST_ROOM_ID 
                    });
                } else { updateStatus('ERROR: No conectado. Recarga la p√°gina.', 'lose'); }
            }
        });

        // Iniciar la conexi√≥n al cargar la p√°gina
        connectSocket();
    </script>
</body>
</html>